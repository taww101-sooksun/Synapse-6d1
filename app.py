import streamlit as st
import pandas as pd
import numpy as np
import time
from streamlit_js_eval import get_geolocation

# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕лр╕Щр╣Йр╕▓р╕Ир╕н
st.set_page_config(page_title="MATRIX_V2: REAL GPS", layout="wide")

st.title("ЁЯЫбя╕П MATRIX_V2: р╕гр╕░р╕Ър╕Ър╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕бр╕┤р╕Хр╕┤р╕Др╕зр╕▓р╕бр╕Ир╕гр╕┤р╕З")
st.write(f"р╕кр╣Вр╕ер╣Бр╕Бр╕Щ: **р╕нр╕вр╕╣р╣Ир╕Щр╕┤р╣Ир╕Зр╣Ж р╣Др╕бр╣Ир╣Ар╕Ир╣Зр╕Ър╕Хр╕▒р╕з**")

# 1. р╕гр╕░р╕Ър╕Ър╕Фр╕╢р╕Зр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╕Чр╕╡р╣Ир╣Бр╕Кр╕гр╣Мр╕бр╕▓р╕Ир╕▓р╕Бр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕З (Live Share)
st.sidebar.header("ЁЯУН р╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╣Бр╕Кр╕гр╣Мр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕З")
loc = get_geolocation()

if loc:
    # --- р╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣Ир╕Чр╕│р╕Зр╕▓р╕Щр╣Ар╕бр╕╖р╣Ир╕нр╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕Др╣Ир╕▓ GPS р╕Ир╕гр╕┤р╕З ---
    curr_lat = loc['coords']['latitude']
    curr_lon = loc['coords']['longitude']
    accuracy = loc['coords']['accuracy']
    
    st.sidebar.success("тЬЕ р╣Бр╕Кр╕гр╣Мр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╕кр╕│р╣Ар╕гр╣Зр╕И")
    st.sidebar.write(f"р╕Юр╕┤р╕Бр╕▒р╕Фр╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ: {curr_lat:.6f}, {curr_lon:.6f}")
    st.sidebar.write(f"р╕Др╕зр╕▓р╕бр╣Бр╕бр╣Ир╕Щр╕вр╕│: {accuracy:.2f} р╣Ар╕бр╕Хр╕г")

    # р╣Ар╕гр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕гр╕лр╕▒р╕к 44 р╕Бр╕╕р╕Нр╣Бр╕И р╣Бр╕ер╕░р╕Рр╕▓р╕Щ 252
    gates = ['A: Stability', 'B: Filtering', 'C: Reflection', 
             'D: Equilibrium', 'E: Silence', 'F: Unity']
    results = []
    ts = time.time() # р╣Ар╕зр╕ер╕▓р╕Ир╕гр╕┤р╕З

    for i, gate in enumerate(gates):
        # р╕Др╕│р╕Щр╕зр╕Ур╕Др╣Ир╕▓р╕Ир╕гр╕┤р╕Зр╕Чр╕╡р╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Хр╕▓р╕бр╕Юр╕┤р╕Бр╕▒р╕Фр╣Бр╕ер╕░р╕зр╕┤р╕Щр╕▓р╕Чр╕╡
        g_plus = np.sin(ts + curr_lat + i) * 44 
        s_minus = np.cos(ts + curr_lon + i) * 44
        sc_unit = abs(g_plus + s_minus) / 7.33
        
        results.append({
            "р╕Фр╣Ир╕▓р╕Щ (Gate)": gate,
            "G+ (р╕Ир╕гр╕┤р╕З)": round(g_plus, 4),
            "S- (р╕Ир╕гр╕┤р╕З)": round(s_minus, 4),
            "р╕лр╕Щр╣Ир╕зр╕вр╕зр╕▒р╕Ф (SC)": round(sc_unit, 4)
        })

    df = pd.DataFrame(results)
    
    # р╣Бр╕кр╕Фр╕Зр╕Хр╕▓р╕гр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Хр╕▓р╕бр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╕Ир╕гр╕┤р╕З
    st.table(df)
    
    # р╕Бр╕гр╕▓р╕Яр╣Бр╕кр╕Фр╕Зр╕Ьр╕е Real-time
    st.line_chart(df["р╕лр╕Щр╣Ир╕зр╕вр╕зр╕▒р╕Ф (SC)"])

    if accuracy > 20:
        st.warning("тЪая╕П р╕Др╕│р╣Ар╕Хр╕╖р╕нр╕Щ: р╕кр╕▒р╕Нр╕Нр╕▓р╕У GPS р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕Щр╕┤р╣Ир╕Зр╕Юр╕н р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╕▓р╕Ир╕бр╕╡р╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╣Ир╕вр╕З")
    else:
        st.info("ЁЯТО р╕кр╕Цр╕▓р╕Щр╕░р╕Юр╕┤р╕Бр╕▒р╕Фр╕Щр╕┤р╣Ир╕Зр╣Бр╕ер╕░р╕Хр╕гр╕Зр╕Хр╕▓р╕бр╕Др╕зр╕▓р╕бр╕Ир╕гр╕┤р╕З")

else:
    # --- р╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣Ир╕Чр╕│р╕Зр╕▓р╕Щр╣Ар╕бр╕╖р╣Ир╕нр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╣Др╕бр╣Ир╕Хр╕гр╕З р╕лр╕гр╕╖р╕нр╣Др╕бр╣Ир╣Др╕Фр╣Йр╣Бр╕Кр╕гр╣Мр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕З ---
    st.error("ЁЯЪи р╕гр╕░р╕Ър╕Ър╕вр╕Бр╣Ар╕ер╕┤р╕Бр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ: р╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╣Др╕бр╣Ир╕Хр╕гр╕Зр╕Хр╕▓р╕бр╕Др╕зр╕▓р╕бр╕Ир╕гр╕┤р╕З")
    st.info("р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕Ф 'Allow' р╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕Кр╕гр╣Мр╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╕Ир╕▓р╕Бр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕Вр╕нр╕Зр╕Др╕╕р╕У р╣Бр╕ер╕░р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕кр╕ар╕▓р╕зр╕░р╕Ир╕гр╕┤р╕З")
    # р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╣Др╕бр╣Ир╣Гр╕лр╣Йр╣Вр╕Др╣Йр╕Фр╕кр╣Ир╕зр╕Щр╕нр╕╖р╣Ир╕Щр╕Чр╕│р╕Зр╕▓р╕Щр╕Цр╣Йр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Ир╕гр╕┤р╕З
    st.stop()
