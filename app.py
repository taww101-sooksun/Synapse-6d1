import streamlit as st
import pandas as pd
import numpy as np
import time
from streamlit_js_eval import get_geolocation

st.set_page_config(page_title="MATRIX_V2: ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á", layout="wide")

# 1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Live Share)
st.sidebar.header("üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á")
loc = get_geolocation()

# ‡∏™‡πÇ‡∏•‡πÅ‡∏Å‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏Ñ‡∏∏‡∏ì
st.title("üåÄ MATRIX_V2: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏°‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á")
st.write("‡∏™‡πÇ‡∏•‡πÅ‡∏Å‡∏ô: **‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏¥‡πà‡∏á‡πÜ ‡πÑ‡∏°‡πà‡πÄ‡∏à‡πá‡∏ö‡∏ï‡∏±‡∏ß**")

if loc:
    # ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å GPS ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ
    curr_lat = loc['coords']['latitude']
    curr_lon = loc['coords']['longitude']
    accuracy = loc['coords']['accuracy']
    
    st.sidebar.success("‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏î")
    st.sidebar.write(f"Lat: {curr_lat:.6f}")
    st.sidebar.write(f"Lon: {curr_lon:.6f}")
    
    # --- ‡∏à‡∏∏‡∏î‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ---
    # ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤ Lat/Lon ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    
    gates = ['A: Stability', 'B: Filtering', 'C: Reflection', 
             'D: Equilibrium', 'E: Silence', 'F: Unity']
    results = []
    ts = time.time() # ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î
    
    for i, gate in enumerate(gates):
        # ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á + ‡∏£‡∏´‡∏±‡∏™ 44 ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ê‡∏≤‡∏ô 252) ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
        # ‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà Lat/Lon ‡∏Ç‡∏¢‡∏±‡∏ö
        g_plus = np.sin(ts + curr_lat + i) * 44 
        s_minus = np.cos(ts + curr_lon + i) * 44
        sc_unit = abs(g_plus + s_minus) / 7.33 # ‡∏ï‡∏±‡∏ß‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ê‡∏≤‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•
        
        results.append({
            "‡∏î‡πà‡∏≤‡∏ô (Gate)": gate,
            "G+ (‡∏à‡∏£‡∏¥‡∏á)": round(g_plus, 4),
            "S- (‡∏à‡∏£‡∏¥‡∏á)": round(s_minus, 4),
            "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ß‡∏±‡∏î (SC)": round(sc_unit, 4)
        })

    df = pd.DataFrame(results)
    
    # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á
    st.table(df)
    
    # ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡πà‡∏á
    if accuracy < 15:
        st.success(f"üíé ‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ô‡∏¥‡πà‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (Accuracy: {accuracy:.2f}m)")
    else:
        st.warning(f"‚ö†Ô∏è ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏Å‡∏ß‡πà‡∏á: ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏¥‡πà‡∏á‡πÜ (Accuracy: {accuracy:.2f}m)")

    # ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    st.line_chart(df["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ß‡∏±‡∏î (SC)"])

else:
