import streamlit as st
import firebase_admin
from firebase_admin import credentials, firestore
import streamlit as st

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© ---
st.set_page_config(page_title="Notty-101 App", layout="wide")

# --- CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏≤ (Gradient) ---
def local_css(color_type):
    if color_type == "‡πÅ‡∏î‡∏á‡πÄ‡∏á‡∏≤":
        bg = "linear-gradient(135deg, #ff4b4b 0%, #8b0000 100%)"
    elif color_type == "‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏á‡∏≤":
        bg = "linear-gradient(135deg, #1e90ff 0%, #00008b 100%)"
    elif color_type == "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏á‡∏≤":
        bg = "linear-gradient(135deg, #32cd32 0%, #006400 100%)"
    elif color_type == "‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏≤":
        bg = "linear-gradient(135deg, #da70d6 0%, #4b0082 100%)"
    elif color_type == "‡∏î‡∏≥‡πÄ‡∏á‡∏≤":
        bg = "linear-gradient(135deg, #434343 0%, #000000 100%)"
    else:
        bg = "#ffffff"

    st.markdown(f"""
        <style>
        .stApp {{
            background: {bg};
            color: white;
        }}
        h1, h2, h3, p, span, label {{
            color: white !important;
        }}
        .stButton>button {{
            border-radius: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid white;
        }}
        </style>
        """, unsafe_allow_html=True)

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ---
if 'page' not in st.session_state:
    st.session_state.page = '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å'

def change_page(page_name):
    st.session_state.page = page_name

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (Main Page) ---
if st.session_state.page == '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å':
    local_css("‡∏î‡∏≥‡πÄ‡∏á‡∏≤")
    st.title("üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å Notty-101")
    st.write("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö")
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("üî¥ ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏á‡πÄ‡∏á‡∏≤"): change_page("‡πÅ‡∏î‡∏á‡πÄ‡∏á‡∏≤")
        if st.button("üîµ ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏á‡∏≤"): change_page("‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏á‡∏≤")
    with col2:
        if st.button("üü¢ ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏á‡∏≤"): change_page("‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏á‡∏≤")
        if st.button("üü£ ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏≤"): change_page("‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏≤")
    
    if st.button("‚ö´ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏≥‡πÄ‡∏á‡∏≤ (‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)"): change_page("‡∏î‡∏≥‡πÄ‡∏á‡∏≤")

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏á‡∏≤ ---
elif st.session_state.page == '‡πÅ‡∏î‡∏á‡πÄ‡∏á‡∏≤':
    local_css("‡πÅ‡∏î‡∏á‡πÄ‡∏á‡∏≤")
    st.title("üî¥ ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏á‡∏≤")
    st.write("‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏µ‡πÅ‡∏î‡∏á")
    if st.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å"): change_page("‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å")

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏á‡∏≤ ---
elif st.session_state.page == '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏á‡∏≤':
    local_css("‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏á‡∏≤")
    st.title("üîµ ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏á‡∏≤")
    st.write("‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô")
    if st.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å"): change_page("‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å")

# --- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏á‡∏≤ ---
elif st.session_state.page == '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏á‡∏≤':
    local_css("‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏á‡∏≤")
    st.title("üü¢ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏á‡∏≤")
    st.write("‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß")
    if st.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å"): change_page("‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å")

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏≤ ---
elif st.session_state.page == '‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏≤':
    local_css("‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏≤")
    st.title("üü£ ‡∏´‡∏ô‡πâ‡∏≤‡∏°‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏≤")
    st.write("‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏°‡πà‡∏ß‡∏á")
    if st.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å"): change_page("‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å")


# 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
def init_firebase():
    if not firebase_admin._apps:
        try:
            # ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Secrets
            cred_info = dict(st.secrets["firebase_service_account"])
            
            # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà (\n) ‡πÉ‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö
            cred_info["private_key"] = cred_info["private_key"].replace("\\n", "\n")
            
            cred = credentials.Certificate(cred_info)
            firebase_admin.initialize_app(cred)
            return True
        except Exception as e:
            st.error(f"‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
            return False
    return True

# 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
if init_firebase():
    st.success("‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡πÅ‡∏≠‡∏õ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß")
    db = firestore.client()
    # --- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
st.divider()
st.subheader("üìù ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠
name_input = st.text_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:")

if st.button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"):
    if name_input:
        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Collection ‡∏ä‡∏∑‡πà‡∏≠ 'test_users'
        db.collection("test_users").add({
            "name": name_input,
            "timestamp": firestore.SERVER_TIMESTAMP
        })
        st.balloons()
        st.success(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠ '{name_input}' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
    else:
        st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö")

# --- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå ---
st.divider()
st.subheader("üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")

users_ref = db.collection("test_users").order_by("timestamp", direction=firestore.Query.DESCENDING)
docs = users_ref.stream()

for doc in docs:
    user_data = doc.to_dict()
    st.write(f"üîπ {user_data.get('name')} (‡πÄ‡∏°‡∏∑‡πà‡∏≠: {user_data.get('timestamp')})")

    
    # --- ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ---
    st.write("‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Notty-101 ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö")
